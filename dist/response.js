"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:!0}),exports.HeimdalResponse=void 0;var _classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck")),_createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass")),_moment=_interopRequireDefault(require("moment")),_message=_interopRequireDefault(require("bsv/message")),_utils=require("./utils"),_constants=require("./constants"),HeimdalResponse=function(){function a(b,c){var d=!!(2<arguments.length&&void 0!==arguments[2])&&arguments[2];(0,_classCallCheck2["default"])(this,a),b=b.replace(/\/+$/,"");var e=c.challenge,f=c.time,g=c.address,h=c.signature,i=c.fields,j=c.bap;this.serverUrl=b,this.challenge=e,this.time=f,this.address=g,this.signature=h,this.fields=i||[],this.signed=null,this.bap=j||[],this.action=d||_constants.DEFAULT_ACTION,this.errors=[]}return(0,_createClass2["default"])(a,[{key:"isValid",value:function isValid(){if(!this.serverUrl||!this.challenge||!this.time||!this.address||!this.signature)return this.errors.push("Not all fields are filled in"),!1;var a=_moment["default"].unix(this.time);if(!a.isValid())return this.errors.push("Invalid time"),!1;if(a.isAfter((0,_moment["default"])()))return this.errors.push("Time is in the future"),!1;if(a.add(30,"seconds").isBefore((0,_moment["default"])()))return this.errors.push("Signature has expired"),!1;var b=Buffer.from(this.getSigningMessage());try{if(!_message["default"].verify(b,this.address,this.signature))return this.errors.push("Could not verify signature"),!1}catch(a){return this.errors.push("Could not verify signature"),!1}if(this.bap&&this.bap.length)try{if(!_message["default"].verify(b,this.bap.address,this.bap.signature))return this.errors.push("Could not verify BAP signature"),!1}catch(a){return this.errors.push("Could not verify BAP signature"),!1}return!0}},{key:"getSigningMessage",value:function getSigningMessage(){return this.serverUrl+"/"+this.challenge+"?time="+this.time+"&f="+encodeURIComponent((0,_utils.jsonStableStringify)(this.fields))}},{key:"setSignature",value:function setSignature(a,b){this.address=a,this.signature=b}},{key:"getResponseUrl",value:function getResponseUrl(){return"".concat(this.serverUrl).concat(this.action)}},{key:"getResponseBody",value:function getResponseBody(){if(!this.challenge||!this.time||!this.address||!this.signature)return this.errors.push("Missing one of the required fields"),!1;var a={challenge:this.challenge,time:this.time,address:this.address,signature:this.signature,fields:this.fields};return this.bap&&(a.bap=this.bap),this.signed&&(a.signed=this.signed),a}},{key:"getId",value:function getId(){return this.address}},{key:"getChallenge",value:function getChallenge(){return this.challenge}},{key:"getFields",value:function getFields(){return this.fields}},{key:"getFieldValue",value:function getFieldValue(a){return this.fields[a]}},{key:"setFieldValue",value:function setFieldValue(a,b){this.fields[a]=b}},{key:"getVerifiedField",value:function getVerifiedField(a){var b,c=null===(b=this.bap)||void 0===b?void 0:b.attributes;return c?c[a]:void 0}},{key:"getVerifiedFieldValue",value:function getVerifiedFieldValue(a){var b=this.getVerifiedField(a);return b?null===b||void 0===b?void 0:b.value:void 0}},{key:"getVerifiedFieldNonce",value:function getVerifiedFieldNonce(a){var b=this.getVerifiedField(a);return b?null===b||void 0===b?void 0:b.nonce:void 0}}]),a}();exports.HeimdalResponse=HeimdalResponse;