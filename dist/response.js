"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:!0}),exports.HeimdalResponse=void 0;var _classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck")),_createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass")),_moment=_interopRequireDefault(require("moment")),_message=_interopRequireDefault(require("bsv/message")),HeimdalResponse=function(){function a(b,c){(0,_classCallCheck2["default"])(this,a);var d=c.challenge,e=c.time,f=c.address,g=c.signature,h=c.fields;this.serverUrl=b,this.challenge=d,this.time=e,this.address=f,this.signature=g,this.fields=h||[],this.errors=[]}return(0,_createClass2["default"])(a,[{key:"isValid",value:function isValid(){if(!this.serverUrl||!this.challenge||!this.time||!this.address||!this.signature)return this.errors.push("Not all fields are filled in"),!1;var a=_moment["default"].unix(this.time);if(!a.isValid())return this.errors.push("Invalid time"),!1;if(a.isAfter((0,_moment["default"])()))return this.errors.push("Time is in the future"),!1;if(a.add(30,"seconds").isBefore((0,_moment["default"])()))return this.errors.push("Signature has expired"),!1;var b=this.serverUrl+this.challenge+"&time="+this.time,c=Buffer.from(b);try{if(!_message["default"].verify(c,this.address,this.signature))return this.errors.push("Could not verify signature"),!1}catch(a){return this.errors.push("Could not verify signature"),!1}return!0}},{key:"getId",value:function getId(){return this.address}},{key:"getChallenge",value:function getChallenge(){return this.challenge}},{key:"getFields",value:function getFields(){return this.fields}},{key:"getFieldValue",value:function getFieldValue(a){return this.fields[a]}},{key:"setFieldValue",value:function setFieldValue(a,b){this.fields[a]=b}},{key:"getVerifiedField",value:function getVerifiedField(a){var b,c=null===(b=this.bap)||void 0===b?void 0:b.attributes;return c?c[a]:void 0}},{key:"getVerifiedFieldValue",value:function getVerifiedFieldValue(a){var b=this.getVerifiedField(a);return b?null===b||void 0===b?void 0:b.value:void 0}},{key:"getVerifiedFieldNonce",value:function getVerifiedFieldNonce(a){var b=this.getVerifiedField(a);return b?null===b||void 0===b?void 0:b.nonce:void 0}}]),a}();exports.HeimdalResponse=HeimdalResponse;